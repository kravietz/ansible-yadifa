---
- name: yadifa package installed
  apt:
    name: yadifa

- name: yadifa client configuration
  template:
    dest: /etc/yadifa.conf
    src: templates/yadifa.conf.j2
  when: yadifa_global_allow_control != "none"

- name: yadifad server configuration
  template:
    dest: /etc/yadifa/yadifad.conf
    src: templates/yadifad.conf.j2
  notify:
  - yadifa cfgreload

- name: sync zone journals
  command: "yadifa -s {{ yadifa_cli_server }} sync {{ item.domain }} clean"
  loop: "{{ yadifa_zones }}"

- name: freeze zones prior to possible zone file updates
  command: "yadifa -s {{ yadifa_cli_server }} freeze {{ item.domain }}"
  loop: "{{ yadifa_zones }}"

- name: zone files
  copy:
    src: "{{ item.file }}"
    dest: "{{ yadifa_masters_dir }}/{{ item.file | basename }}"
  loop: "{{ yadifa_zones }}"
  notify:
  - yadifa reload zones

- name: unfreeze zones
  command: "yadifa -s {{ yadifa_cli_server }} unfreeze {{ item.domain }}"
  loop: "{{ yadifa_zones }}"

- name: yadifad AppArmor profile
  copy:
    src: files/apparmor/usr.sbin.yadifad
    dest: /etc/apparmor.d/usr.sbin.yadifad
  notify:
  - yadifad apparmor

- name: yadifa systemd overrides
  copy:
    src: files/systemd.ini
    dest: /etc/systemd/system/yadifa.service.d/override.conf

- name: yadifa service started
  service:
    name: yadifa
    state: started
    enabled: yes

  # required for dnssec-dsfromkey
- name: bind9utils package installed
  apt:
    name: bind9utils
  when: yadifa_show_ds

- name: obtain DS records
  shell: "dig dnskey {{ item.domain }} @{{ yadifa_cli_server }} | dnssec-dsfromkey -f - {{ item.domain }}"
  loop: "{{ yadifa_zones }}"
  register: ds

- name: display DS records
  debug: var=ds
  when: yadifa_show_ds
